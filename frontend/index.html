<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>楽天選品・運営エージェント コンソール（MVP）</title>
  <link rel="icon" type="image/png" href="/ui/icon-192.png">

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#020617" />
  <link rel="manifest" href="/ui/manifest.webmanifest" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900">

  <!-- ===== アクセスパスワード入力 Modal ===== -->
  <div
    id="tokenModal"
    class="fixed inset-0 bg-slate-900/70 flex items-center justify-center z-50"
  >
    <div class="bg-slate-950 border border-indigo-500/50 rounded-2xl p-4 w-full max-w-sm shadow-xl">
      <h2 class="text-sm font-semibold text-slate-50 mb-2">アクセスパスワード</h2>
      <p class="text-[11px] text-slate-400 mb-3">
        Render の環境変数 <span class="font-mono">AGENT_ACCESS_TOKEN</span> と同じ値を入力してください。
      </p>

      <form id="agentTokenForm" class="space-y-2">
        <input
          id="agentTokenInput"
          type="password"
          class="w-full rounded-md border border-slate-500 bg-slate-900 px-2 py-1 text-sm text-slate-50 placeholder-slate-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          placeholder="アクセスパスワード"
        />
        <p id="tokenError" class="h-[14px] text-[11px] text-rose-400"></p>
        <div class="flex justify-end pt-1">
          <button
            type="submit"
            class="inline-flex items-center rounded bg-indigo-500 px-3 py-1 text-[11px] font-semibold text-slate-50 hover:bg-indigo-400"
          >
            OK
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== メインコンテンツ：全 STEP を同じ幅コンテナ内に配置 ===== -->
  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">

    <!-- Step 1: 自動選品 -->
    <section class="bg-white rounded-2xl shadow p-4 md:p-6">
      <h2 class="text-lg font-semibold mb-2">STEP1：自動選品（市場トレンド＋1688）</h2>
      <p class="text-sm text-slate-600 mb-4">
        楽天＋Amazonトレンドから有望カテゴリを選び、1688 から候補商品を自動収集します。
      </p>

      <form id="autoSelectForm" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
          <label
            for="budgetLevelSelect"
            class="block text-sm font-medium text-slate-700 mb-1"
          >
            資金レベル（客単価帯）
          </label>
          <select
            id="budgetLevelSelect"
            class="w-full border rounded-lg px-2 py-1 text-sm"
          >
            <option value="low">低め（～2,000円）</option>
            <option value="mid">中程度（2,000～5,000円）</option>
            <option value="high">高め（5,000円～）</option>
          </select>
        </div>

        <div>
          <label class="block text-xs font-medium text-slate-900 mb-1">
            避けたいジャンルキーワード（日文・カンマ区切り）
          </label>
          <input
            id="avoidKeywordsInput"
            type="text"
            class="w-full rounded-md border border-slate-300 px-2 py-1 text-sm text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            placeholder="避けたいジャンル"
          />
          <p class="mt-1 text-[10px] text-slate-400">
            例：ベビー、食品
          </p>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              カテゴリ数（top_k）
            </label>
            <input
              id="topKCategories"
              type="number"
              min="1"
              max="10"
              value="3"
              class="w-full border rounded-lg px-2 py-1 text-sm"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              カテゴリごとの最大件数
            </label>
            <input
              id="maxItemsPerCategory"
              type="number"
              min="5"
              max="100"
              value="20"
              class="w-full border rounded-lg px-2 py-1 text-sm"
            />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              1688 仕入れ下限（CNY）
            </label>
            <input
              id="minPriceCny"
              type="number"
              min="0"
              value="5"
              class="w-full border rounded-lg px-2 py-1 text-sm"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              1688 仕入れ上限（CNY）
            </label>
            <input
              id="maxPriceCny"
              type="number"
              min="0"
              value="40"
              class="w-full border rounded-lg px-2 py-1 text-sm"
            />
          </div>
        </div>

        <div class="flex items-end">
          <button
            type="submit"
            class="w-full md:w-auto px-4 py-2 rounded-lg bg-slate-900 text-white text-sm font-medium hover:bg-slate-800"
          >
            自動選品を実行する
          </button>
        </div>
      </form>

      <!-- 結果表示エリア（STEP1 セクション内） -->
      <div id="autoSelectStatus" class="text-xs text-slate-500 mb-2"></div>
      <div id="autoSelectResults" class="space-y-4 text-sm"></div>
    </section>

    <!-- Step 2: 1688 URL インポート（半自動） -->
    <section id="profitSection" class="bg-white rounded-2xl shadow p-4 md:p-6">
      <h2 class="text-lg font-semibold mb-2">STEP2：楽天利益シミュレーション</h2>
      <p class="text-sm text-slate-600 mb-4">
        選んだ候補商品の仕入れ原価・物流費・楽天手数料をもとに、1商品あたりの利益を試算します。
      </p>

      <form id="aliUrlForm" class="flex flex-col md:flex-row gap-2 mb-3">
        <input
          id="aliUrlInput"
          type="url"
          placeholder="https://detail.1688.com/offer/....html"
          class="flex-1 border rounded-lg px-2 py-1 text-sm"
        />
        <button
          type="submit"
          class="px-3 py-1.5 rounded-lg bg-emerald-600 text-white text-sm"
        >
          1688 商品情報を取得
        </button>
      </form>

      <div id="aliUrlResult" class="text-xs text-slate-500"></div>
    </section>

    <!-- Step 2: 利益シミュレーション本体 -->
    <section class="bg-white rounded-2xl shadow p-4 md:p-6">
      <h2 class="text-lg font-semibold mb-2">STEP2：楽天利益シミュレーション</h2>
      <p class="text-sm text-slate-600 mb-4">
        選んだ候補商品の仕入れ原価・物流費・楽天手数料をもとに、1商品あたりの利益を試算します。
      </p>

      <form id="profitForm" class="space-y-3">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">
              為替レート（1 CNY = ? JPY）
            </label>
            <input
              id="fxRate"
              type="number"
              step="0.1"
              value="21.0"
              class="w-full border rounded-lg px-2 py-1 text-sm"
            />
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">
              楽天手数料率（概算）
            </label>
            <input
              id="feeRate"
              type="number"
              step="0.01"
              value="0.15"
              class="w-full border rounded-lg px-2 py-1 text-sm"
            />
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">
              商品ID（任意）</label>
            <input
              id="profitProductId"
              type="text"
              class="w-full border rounded-lg px-2 py-1 text-sm"
              placeholder="例）cat1_p1"
            />
          </div>
          <div class="md:col-span-2">
            <label class="block text-xs font-medium text-slate-700 mb-1">
              中国語タイトル</label>
            <input
              id="profitTitleCn"
              type="text"
              class="w-full border rounded-lg px-2 py-1 text-sm"
              placeholder="1688の商品タイトル"
            />
          </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">
              1688 原価（CNY）
            </label>
            <input
              id="costCny"
              type="number"
              step="0.1"
              class="w-full border rounded-lg px-2 py-1 text-sm"
            />
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">
              単位物流費（CNY）
            </label>
            <input
              id="shippingCny"
              type="number"
              step="0.1"
              value="5"
              class="w-full border rounded-lg px-2 py-1 text-sm"
            />
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">
              その他コスト（JPY）
            </label>
            <input
              id="otherFeeJpy"
              type="number"
              step="1"
              value="50"
              class="w-full border rounded-lg px-2 py-1 text-sm"
            />
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">
              楽天販売価格（JPY）
            </label>
            <input
              id="sellPriceJpy"
              type="number"
              step="10"
              value="2480"
              class="w-full border rounded-lg px-2 py-1 text-sm"
            />
          </div>
          <div class="flex items-end">
            <button
              type="submit"
              class="w-full md:w-auto px-4 py-2 rounded-lg bg-emerald-600 text-white text-sm font-medium hover:bg-emerald-500"
            >
              利益を試算する
            </button>
          </div>
        </div>
      </form>

      <div id="profitResult" class="mt-4 text-sm"></div>
    </section>

    <!-- Step 3: 商品ページ文案生成 -->
    <section id="listingSection" class="bg-white rounded-2xl shadow p-4 md:p-6">
      <h2 class="text-lg font-semibold mb-2">STEP3：楽天商品ページ文案生成</h2>
      <p class="text-sm text-slate-600 mb-4">
        1688 の中国語情報から、楽天向けの日本語タイトル・箇条書き・説明文・検索キーワードを自動生成します。
      </p>

      <form id="listingForm" class="space-y-3">
        <div>
          <label class="block text-xs font-medium text-slate-700 mb-1">
            中国語タイトル</label>
          <input
            id="listingTitleCn"
            type="text"
            class="w-full border rounded-lg px-2 py-1 text-sm"
            placeholder="1688の商品タイトル"
          />
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-700 mb-1">
            中国語の商品説明（任意）</label>
          <textarea
            id="listingDescCn"
            rows="3"
            class="w-full border rounded-lg px-2 py-1 text-sm"
            placeholder="1688の商品説明文（そのまま貼り付けでもOK）"
          ></textarea>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">
              優先して入れたい日本語キーワード（カンマ区切り）</label>
            <input
              id="listingKeywordsJp"
              type="text"
              class="w-full border rounded-lg px-2 py-1 text-sm"
              placeholder="例）キッチン収納, 調味料ラック, 北欧風"
            />
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">
              文体</label>
            <select
              id="listingTone"
              class="w-full border rounded-lg px-2 py-1 text-sm"
            >
              <option value="シンプル">シンプル</option>
              <option value="丁寧">丁寧</option>
              <option value="カジュアル">カジュアル</option>
            </select>
          </div>
        </div>

        <button
          type="submit"
          class="px-4 py-2 rounded-lg bg-indigo-600 text-white text-sm font-medium hover:bg-indigo-500"
        >
          日本語商品ページ文案を生成
        </button>
      </form>

      <div id="listingResult" class="mt-4 text-sm space-y-3"></div>
    </section>

  </main>

  <script>
    // ===== 共通：Token 管理 + secureFetch =====
   // ===== 共通：Token 管理 + secureFetch（毎回ページ読み込み時にモーダルを出す版） =====
let agentToken = "";  // ページをリロードしたら毎回リセット

// =======================
// パスワードモーダル処理
// =======================
document.addEventListener("DOMContentLoaded", () => {
  const tokenModal = document.getElementById("tokenModal");
  const tokenForm = document.getElementById("agentTokenForm");
  const tokenInput = document.getElementById("agentTokenInput");
  const tokenError = document.getElementById("tokenError");

  // ページ読み込み時：必ず一度モーダルを表示
  if (tokenModal) {
    tokenModal.classList.remove("hidden");
  }

  if (tokenForm && tokenInput) {
    tokenForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const value = (tokenInput.value || "").trim();
      console.log("[token] submit value =", value);

      if (!value) {
        if (tokenError) {
          tokenError.textContent = "パスワードを入力してください。";
        }
        return;
      }

      // 先暂存到内存（真正是否正确，要以 /auth/check 为准）
      agentToken = value;

      try {
        const baseUrl = window.location.origin;
        const resp = await fetch(baseUrl + "/auth/check", {
          method: "GET",
          headers: {
            "X-Agent-Token": agentToken,
          },
        });

        console.log("[token] /auth/check status =", resp.status);

        if (resp.ok) {
          // 密码正确
          if (tokenError) tokenError.textContent = "";
          if (tokenModal) tokenModal.classList.add("hidden");
          console.log("[token] auth OK, modal closed");
        } else if (resp.status === 401 || resp.status === 403) {
          // 密码错误 → 清空 token + 显示错误，不关弹窗
          agentToken = "";
          if (tokenError) {
            tokenError.textContent = "パスワードが正しくありません。";
          }
          console.log("[token] auth NG (401/403)");
        } else {
          // 其他 HTTP 错误
          agentToken = "";
          if (tokenError) {
            tokenError.textContent =
              "通信エラーが発生しました。時間をおいて再度お試しください。";
          }
          console.log("[token] auth NG (other http error)");
        }
      } catch (err) {
        // 网络或 JS 异常
        console.error("[token] auth error:", err);
        agentToken = "";
        if (tokenError) {
          tokenError.textContent =
            "通信エラーが発生しました。時間をおいて再度お試しください。";
        }
      }
    });
  }
});



// 后续所有 API 请求都通过 secureFetch，自动带上 X-Agent-Token
async function secureFetch(path, options = {}) {
  const baseUrl = window.location.origin;
  const headers = Object.assign({}, options.headers || {});

  if (!headers["Content-Type"] && !(options.body instanceof FormData)) {
    headers["Content-Type"] = "application/json";
  }

  // ★ 关键：把 token 写到请求头
  if (agentToken) {
    headers["X-Agent-Token"] = agentToken;
  }

  const resp = await fetch(baseUrl + path, {
    ...options,
    headers,
  });

  // 如果后端返回 401/403，认为是密码错误 → 重新弹框＋提示
  if (resp.status === 401 || resp.status === 403) {
    const tokenModal = document.getElementById("tokenModal");
    const tokenError = document.getElementById("tokenError");
    const tokenInput = document.getElementById("agentTokenInput");

    agentToken = "";  // 当前 token 作废
    if (tokenInput) tokenInput.value = "";
    if (tokenError) tokenError.textContent = "パスワードが正しくありません。";
    if (tokenModal) tokenModal.classList.remove("hidden");
  }

  return resp;
}


    async function secureFetch(path, options = {}) {
      const baseUrl = window.location.origin;
      const headers = Object.assign({}, options.headers || {});

      if (!headers["Content-Type"] && !(options.body instanceof FormData)) {
        headers["Content-Type"] = "application/json";
      }

      if (agentToken) {
        headers["X-Agent-Token"] = agentToken;
      }

      const resp = await fetch(baseUrl + path, {
        ...options,
        headers,
      });

      // 認証エラーのときはモーダルを再表示してエラー文言
      if (resp.status === 401 || resp.status === 403) {
        const tokenModal = document.getElementById("tokenModal");
        const tokenError = document.getElementById("tokenError");
        const tokenInput = document.getElementById("agentTokenInput");

        agentToken = "";
        localStorage.removeItem(TOKEN_STORAGE_KEY);
        if (tokenInput) tokenInput.value = "";
        if (tokenError) tokenError.textContent = "パスワードが正しくありません。";
        if (tokenModal) tokenModal.classList.remove("hidden");
      }

      return resp;
    }

    // Service Worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("/ui/service-worker.js")
          .then((reg) => {
            console.log("Service Worker registered:", reg.scope);
          })
          .catch((err) => {
            console.log("Service Worker registration failed:", err);
          });
      });
    }

    // 全局：保存最新一次自動選品结果＆请求参数
    window.lastAutoSelectResults = [];
    window.lastAutoSelectPayload = null;

    // ===== STEP1：自動選品 =====
    const autoSelectFormEl = document.getElementById("autoSelectForm");
    if (autoSelectFormEl) {
      autoSelectFormEl.addEventListener("submit", async (e) => {
        e.preventDefault();

        const statusEl = document.getElementById("autoSelectStatus");
        const resultEl = document.getElementById("autoSelectResults");

        if (!statusEl || !resultEl) {
          console.warn("autoSelectStatus or autoSelectResults not found");
          return;
        }

        statusEl.textContent = "選品中...（/market_auto_select にリクエスト中）";
        resultEl.innerHTML = "";

        try {
          const budgetSelect   = document.getElementById("budgetLevelSelect");
          const avoidInput     = document.getElementById("avoidKeywordsInput");
          const topKInput      = document.getElementById("topKCategories");
          const maxItemsInput  = document.getElementById("maxItemsPerCategory");
          const minPriceInput  = document.getElementById("minPriceCny");
          const maxPriceInput  = document.getElementById("maxPriceCny");

          const budget_level = (budgetSelect?.value || "low");

          const rawAvoid = (avoidInput?.value || "");
          const avoid_keywords = rawAvoid
            .split(/[,，、\s]+/)
            .map((s) => s.trim())
            .filter(Boolean);

          const top_k_categories = parseInt(topKInput?.value || "3", 10);
          const max_items_per_category = parseInt(maxItemsInput?.value || "20", 10);
          const min_price_cny = parseFloat(minPriceInput?.value || "5");
          const max_price_cny = parseFloat(maxPriceInput?.value || "40");

          const payload = {
            budget_level,
            avoid_keywords,
            top_k_categories,
            max_items_per_category,
            min_price_cny,
            max_price_cny,
          };

          window.lastAutoSelectPayload = payload;

          const resp = await secureFetch("/market_auto_select", {
            method: "POST",
            body: JSON.stringify(payload),
          });

          if (!resp.ok) {
            let msg = "HTTP " + resp.status;
            try {
              const errJson = await resp.json();
              if (errJson?.detail) msg = errJson.detail;
            } catch (_) {}
            throw new Error(msg);
          }

          const data = await resp.json();
          statusEl.textContent = "選品完了";

          const suggestions = data.suggestions || data.results || [];
          if (!suggestions.length) {
            resultEl.textContent =
              "該当するカテゴリがありませんでした。条件を緩めて再度お試しください。";
            return;
          }

          window.lastAutoSelectResults = suggestions;

          let html = `
            <div class="flex items-center justify-between mb-2">
              <div class="text-xs font-semibold text-slate-800">
                自動選品結果（${suggestions.length} カテゴリ）
              </div>
              <button
                type="button"
                class="inline-flex items-center rounded bg-slate-800 px-3 py-1 text-[11px] font-semibold text-slate-50 hover:bg-slate-700"
                onclick="downloadMarketCsv()"
              >
                CSV出力
              </button>
            </div>
          `;

          suggestions.forEach((cat, ci) => {
            const jpCat = cat.jp_category || "";
            const scene = cat.scene || "";
            const trend = cat.trend_reason || "";
            const kw1688 = cat.category_keyword_1688 || "";
            const risk = cat.risk_level || "low";
            const riskNotes = cat.risk_notes || "";
            const items = cat.items || [];

            html += `
              <div class="mb-4 rounded-lg border border-slate-300 bg-white shadow-sm">
                <div class="px-3 py-2 border-b border-slate-200 flex items-center justify-between">
                  <div>
                    <div class="text-xs font-semibold text-slate-900">${jpCat}</div>
                    <div class="text-[11px] text-slate-600">${scene}</div>
                  </div>
                  <div class="flex flex-col items-end gap-1">
                    <span class="inline-flex items-center rounded-full border px-2 py-[1px] text-[10px]
                                 ${
                                   risk === "low"
                                     ? "border-emerald-400 text-emerald-600"
                                     : risk === "mid"
                                     ? "border-amber-400 text-amber-600"
                                     : "border-red-400 text-red-600"
                                 }">
                      リスク: ${risk}
                    </span>
                    ${
                      kw1688
                        ? `<span class="inline-flex items-center rounded-full bg-slate-100 px-2 py-[1px] text-[10px] text-slate-700">
                             1688 検索キーワード: ${kw1688}
                           </span>`
                        : ""
                    }
                  </div>
                </div>

                <div class="px-3 py-2 border-b border-slate-200">
                  <div class="text-[11px] text-slate-600 whitespace-pre-line">
                    ${trend}
                  </div>
                  ${
                    riskNotes
                      ? `<div class="mt-1 text-[11px] text-slate-500">注意点: ${riskNotes}</div>`
                      : ""
                  }
                </div>

                <div class="px-3 py-2">
                  ${
                    !items.length
                      ? `<div class="text-[11px] text-slate-500">このカテゴリでは条件に合う候補商品が見つかりませんでした。</div>`
                      : `
                        <table class="w-full border-collapse text-[11px]">
                          <thead>
                            <tr class="border-b border-slate-200 bg-slate-50">
                              <th class="px-1 py-1 text-left font-medium text-slate-600">#</th>
                              <th class="px-1 py-1 text-left font-medium text-slate-600">商品タイトル（中国語）</th>
                              <th class="px-1 py-1 text-right font-medium text-slate-600">仕入価格 (CNY)</th>
                              <th class="px-1 py-1 text-right font-medium text-slate-600">スコア</th>
                              <th class="px-1 py-1 text-center font-medium text-slate-600">操作</th>
                            </tr>
                          </thead>
                          <tbody>
                            ${items
                              .map((item, ii) => {
                                const t = item.title_cn || "";
                                const price = item.price_cny ?? "";
                                const score = item.score ?? "";
                                return `
                                  <tr class="border-b border-slate-100 hover:bg-slate-50">
                                    <td class="px-1 py-1 align-top text-slate-500">${ii + 1}</td>
                                    <td class="px-1 py-1 align-top text-slate-800">${t}</td>
                                    <td class="px-1 py-1 align-top text-right text-slate-800">${price}</td>
                                    <td class="px-1 py-1 align-top text-right text-slate-800">${score}</td>
                                    <td class="px-1 py-1 align-top">
                                      <div class="flex flex-col gap-1 items-stretch">
                                        <button type="button"
                                          class="w-full rounded bg-emerald-500 text-[10px] font-semibold text-white py-[3px]"
                                          onclick="useForProfit(${ci}, ${ii})">
                                          利益試算へ
                                        </button>
                                        <button type="button"
                                          class="w-full rounded bg-indigo-500 text-[10px] font-semibold text-white py-[3px]"
                                          onclick="useForListing(${ci}, ${ii})">
                                          文案作成へ
                                        </button>
                                      </div>
                                    </td>
                                  </tr>
                                `;
                              })
                              .join("")}
                          </tbody>
                        </table>
                      `
                  }
                </div>
              </div>
            `;
          });

          resultEl.innerHTML = html;
        } catch (err) {
          console.error(err);
          statusEl.textContent = "自動選品に失敗しました：" + err;
          resultEl.innerHTML =
            '<p class="text-xs text-red-500">1688 側との通信に問題が発生しました。しばらくしてから再度お試しください。</p>';
        }
      });
    }

    // ===== CSV 出力（STEP1 結果を CSV エクスポート） =====
    window.downloadMarketCsv = async function () {
      try {
        const payload = window.lastAutoSelectPayload;
        if (!payload) {
          alert("先に一度『自動選品』を実行してください。");
          return;
        }

        const resp = await secureFetch("/market_auto_select_csv", {
          method: "POST",
          body: JSON.stringify(payload),
        });

        if (!resp.ok) {
          let msg = "HTTP " + resp.status;
          try {
            const errJson = await resp.json();
            if (errJson?.detail) msg = errJson.detail;
          } catch (_) {}
          throw new Error(msg);
        }

        const csvText = await resp.text();
        // ★ Excel で文字化けしないように UTF-8 BOM を付与
        const csvWithBom = "\uFEFF" + csvText;

        const blob = new Blob([csvWithBom], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const now = new Date();
        const ts = now.toISOString().slice(0, 19).replace(/[-T:]/g, "");
        a.href = url;
        a.download = `market_auto_select_${ts}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error(err);
        alert("CSV 出力に失敗しました：" + err);
      }
    };

    // ===== STEP1 → STEP2/3 連携 =====
    window.useForProfit = function (catIndex, itemIndex) {
      const cats = window.lastAutoSelectResults || [];
      const cat = cats[catIndex];
      if (!cat) return;
      const item = (cat.items || [])[itemIndex];
      if (!item) return;

      const idInput = document.getElementById("profitProductId");
      const titleInput = document.getElementById("profitTitleCn");
      const costInput = document.getElementById("costCny");

      if (idInput) {
        idInput.value =
          (cat.jp_category || "cat") + "_" + (item.id || ("i" + itemIndex));
      }
      if (titleInput) {
        titleInput.value = item.title_cn || "";
      }
      if (costInput) {
        costInput.value = item.price_cny ?? "";
      }

      const section = document.getElementById("profitSection");
      if (section && section.scrollIntoView) {
        section.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    };

    window.useForListing = function (catIndex, itemIndex) {
      const cats = window.lastAutoSelectResults || [];
      const cat = cats[catIndex];
      if (!cat) return;
      const item = (cat.items || [])[itemIndex];
      if (!item) return;

      const titleInput = document.getElementById("listingTitleCn");
      const descInput = document.getElementById("listingDescCn");
      const kwInput = document.getElementById("listingKeywordsJp");

      if (titleInput) {
        titleInput.value = item.title_cn || "";
      }
      if (descInput) {
        descInput.value = "";
      }
      if (kwInput) {
        kwInput.value = (cat.jp_category || "")
          .replace("Amazon｜", "")
          .replace(/[（）\(\)]/g, " ");
      }

      const section = document.getElementById("listingSection");
      if (section && section.scrollIntoView) {
        section.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    };

    // ===== STEP2: 利益シミュレーション =====
    document.getElementById("profitForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const resultEl = document.getElementById("profitResult");
      resultEl.textContent = "計算中...";

      const fxRate = parseFloat(document.getElementById("fxRate").value || "21");
      const feeRate = parseFloat(document.getElementById("feeRate").value || "0.15");

      const productId = document.getElementById("profitProductId").value || "p1";
      const titleCn = document.getElementById("profitTitleCn").value || "";

      const costCny = parseFloat(document.getElementById("costCny").value || "0");
      const shippingCny = parseFloat(document.getElementById("shippingCny").value || "0");
      const otherFeeJpy = parseFloat(document.getElementById("otherFeeJpy").value || "0");
      const sellPriceJpy = parseFloat(document.getElementById("sellPriceJpy").value || "0");

      const payload = {
        fx_rate: fxRate,
        rakuten_fee_rate: feeRate,
        items: [
          {
            product_id: productId,
            title_cn: titleCn,
            cost_cny: costCny,
            shipping_cny: shippingCny,
            sell_price_jpy: sellPriceJpy,
            other_fee_jpy: otherFeeJpy
          }
        ]
      };

      try {
        const resp = await secureFetch("/rakuten_profit_simulate", {
          method: "POST",
          body: JSON.stringify(payload),
        });

        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();

        const item = (data.items || [])[0];
        if (!item) {
          resultEl.innerHTML = "<div class='text-xs text-red-500'>計算結果が空です。</div>";
          return;
        }

        resultEl.innerHTML = `
          <div class="border rounded-xl p-3 bg-slate-50">
            <div class="text-xs text-slate-500 mb-1">商品ID：${item.product_id}</div>
            <div class="text-sm font-medium mb-1">${item.title_cn || ""}</div>
            <div class="text-xs space-y-1">
              <div>総コスト：<span class="font-semibold">${item.cost_total_jpy}</span> 円（原価＋物流＋その他）</div>
              <div>楽天手数料（概算）：<span class="font-semibold">${item.rakuten_fee_jpy}</span> 円</div>
              <div>1件あたり粗利：<span class="font-semibold">${item.gross_profit_jpy}</span> 円</div>
              <div>利益率：<span class="font-semibold">${(item.margin * 100).toFixed(1)}%</span></div>
              <div class="mt-1 text-emerald-700">${item.advice}</div>
            </div>
          </div>
        `;
      } catch (err) {
        console.error(err);
        resultEl.innerHTML = "<div class='text-xs text-red-500'>利益シミュレーションに失敗しました：" + err + "</div>";
      }
    });

    // ===== STEP3: 楽天商品ページ文案生成 =====
    document.getElementById("listingForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const resultEl = document.getElementById("listingResult");
      resultEl.textContent = "生成中...";

      const titleCn = document.getElementById("listingTitleCn").value || "";
      const descCn = document.getElementById("listingDescCn").value || "";
      const kwRaw = document.getElementById("listingKeywordsJp").value || "";
      const tone = document.getElementById("listingTone").value || "シンプル";

      const keywordsJp = kwRaw
        .split(",")
        .map((s) => s.trim())
        .filter((s) => s.length > 0);

      const payload = {
        title_cn: titleCn,
        desc_cn: descCn,
        keywords_jp: keywordsJp,
        shop_tone: tone
      };

      try {
        const resp = await secureFetch("/rakuten_listing_copy", {
          method: "POST",
          body: JSON.stringify(payload),
        });

        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();

        if (data.raw_text) {
          resultEl.innerHTML = `
            <div class="border rounded-xl p-3 bg-slate-50">
              <div class="text-xs text-red-500 mb-2">JSON 解析に失敗したため、生テキストを表示します。</div>
              <pre class="whitespace-pre-wrap text-xs">${data.raw_text}</pre>
            </div>
          `;
          return;
        }

        resultEl.innerHTML = `
          <div class="border rounded-xl p-3 bg-slate-50 space-y-2">
            <div>
              <div class="text-xs font-semibold text-slate-600 mb-1">楽天用タイトル</div>
              <div class="text-sm">${data.title_jp || ""}</div>
            </div>
            <div>
              <div class="text-xs font-semibold text-slate-600 mb-1">箇条書き（売りポイント）</div>
              <ul class="list-disc list-inside text-sm">
                ${(data.bullets_jp || [])
                  .map((b) => `<li>${b}</li>`)
                  .join("")}
              </ul>
            </div>
            <div>
              <div class="text-xs font-semibold text-slate-600 mb-1">商品説明文</div>
              <div class="text-sm whitespace-pre-wrap">${data.description_jp || ""}</div>
            </div>
            <div>
              <div class="text-xs font-semibold text-slate-600 mb-1">検索キーワード候補</div>
              <div class="text-xs">
                ${(data.search_keywords_jp || []).join(" / ")}
              </div>
            </div>
          </div>
        `;
      } catch (err) {
        console.error(err);
        resultEl.innerHTML = "<div class='text-xs text-red-500'>文案生成に失敗しました：" + err + "</div>";
      }
    });

    // ===== 1688 URL インポート（STEP2） =====
    let lastParsed1688Item = null;

    const aliUrlForm = document.getElementById("aliUrlForm");
    if (aliUrlForm) {
      aliUrlForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const urlInput = document.getElementById("aliUrlInput");
        const url = (urlInput.value || "").trim();
        const resultEl = document.getElementById("aliUrlResult");

        if (!url) {
          resultEl.innerHTML =
            "<div class='text-xs text-red-500'>1688 の商品URLを入力してください。</div>";
          return;
        }

        resultEl.innerHTML =
          "<div class='text-xs text-slate-500'>解析中...</div>";

        try {
          const resp = await secureFetch("/ali1688/parse_url", {
            method: "POST",
            body: JSON.stringify({ url }),
          });

          if (!resp.ok) {
            const errJson = await resp.json().catch(() => null);
            const msg = errJson?.detail || ("HTTP " + resp.status);
            throw new Error(msg);
          }

          const data = await resp.json();
          lastParsed1688Item = data;

          resultEl.innerHTML = `
            <div class="border border-emerald-200 rounded-lg p-3 text-xs space-y-2">
              <div class="font-semibold text-slate-800 mb-1">解析結果</div>
              <div><span class="font-medium">タイトル（CN）：</span>${data.title_cn || "(取得できませんでした)"}</div>
              <div><span class="font-medium">価格（CNY）：</span>${data.price_cny ?? "(不明)"}</div>
              <div class="flex flex-wrap gap-2 mt-1">
                <button type="button"
                  class="px-2 py-1 rounded bg-emerald-600 text-white"
                  onclick="applyParsed1688ToProfit()">
                  利益試算に反映
                </button>
                <button type="button"
                  class="px-2 py-1 rounded bg-indigo-600 text-white"
                  onclick="applyParsed1688ToListing()">
                  文案生成に反映
                </button>
              </div>
            </div>
          `;
        } catch (err) {
          console.error(err);
          resultEl.innerHTML =
            "<div class='text-xs text-red-500'>解析に失敗しました：" + err + "</div>";
        }
      });
    }

    window.applyParsed1688ToProfit = function () {
      if (!lastParsed1688Item) return;
      const it = lastParsed1688Item;
      const titleInput = document.getElementById("profitTitleCn");
      const costInput = document.getElementById("costCny");

      if (titleInput && it.title_cn) {
        titleInput.value = it.title_cn;
      }
      if (costInput && typeof it.price_cny === "number") {
        costInput.value = it.price_cny;
      }
    };

    window.applyParsed1688ToListing = function () {
      if (!lastParsed1688Item) return;
      const it = lastParsed1688Item;
      const titleInput = document.getElementById("listingTitleCn");
      if (titleInput && it.title_cn) {
        titleInput.value = it.title_cn;
      }
    };
  </script>
</body>
</html>
