<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>楽天選品・運営エージェント コンソール（MVP）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#020617" />
  <link rel="manifest" href="/ui/manifest.webmanifest" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>


  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- Step 1: 自動選品 -->
    <section class="bg-white rounded-2xl shadow p-4 md:p-6">
      <h2 class="text-lg font-semibold mb-2">STEP1：自動選品（市場トレンド＋1688）</h2>
      <p class="text-sm text-slate-600 mb-4">
        楽天＋Amazonトレンドから有望カテゴリを選び、1688 から候補商品を自動収集します。
      </p>

      <form id="autoSelectForm" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">
            資金レベル（客単価帯）
          </label>
          <select id="budgetLevel" class="w-full border rounded-lg px-2 py-1 text-sm">
            <option value="low">低め（〜3,000円中心）</option>
            <option value="mid">中〜高（3,000〜8,000円）</option>
            <option value="high">高単価（8,000円〜）</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">
            避けたいジャンルキーワード（日文・カンマ区切り）
          </label>
          <input
            id="avoidKeywords"
            type="text"
            class="w-full border rounded-lg px-2 py-1 text-sm"
            placeholder="例）ベビー, 食品"
            value="ベビー, 食品"
          />
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              カテゴリ数（top_k）
            </label>
            <input
              id="topKCategories"
              type="number"
              min="1"
              max="10"
              value="3"
              class="w-full border rounded-lg px-2 py-1 text-sm"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              カテゴリごとの最大件数
            </label>
            <input
              id="maxItemsPerCategory"
              type="number"
              min="5"
              max="100"
              value="20"
              class="w-full border rounded-lg px-2 py-1 text-sm"
            />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              1688 仕入れ下限（CNY）
            </label>
            <input
              id="minPriceCny"
              type="number"
              min="0"
              value="5"
              class="w-full border rounded-lg px-2 py-1 text-sm"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              1688 仕入れ上限（CNY）
            </label>
            <input
              id="maxPriceCny"
              type="number"
              min="0"
              value="40"
              class="w-full border rounded-lg px-2 py-1 text-sm"
            />
          </div>
        </div>

        <div class="flex items-end">
          <button
            type="submit"
            class="w-full md:w-auto px-4 py-2 rounded-lg bg-slate-900 text-white text-sm font-medium hover:bg-slate-800"
          >
            自動選品を実行する
          </button>
        </div>
      </form>

      <div id="autoSelectStatus" class="text-xs text-slate-500 mb-2"></div>
      <div id="autoSelectResults" class="space-y-4 text-sm"></div>
    </section>

    <!-- Step 2: 利益シミュレーション -->
        <!-- 1688 URL インポート（半自動） -->
    <section class="bg-white rounded-2xl shadow p-4 md:p-6">
      <h2 class="text-lg font-semibold mb-2">STEP1.5：1688 商品URLインポート（半自動）</h2>
      <p class="text-sm text-slate-600 mb-3">
        1688 で目視選定した商品URLを貼り付けて、タイトルと仕入れ単価を自動取得します。
        取得できない場合は、ブラウザで開いて手動でコピーしてください。
      </p>

      <form id="aliUrlForm" class="flex flex-col md:flex-row gap-2 mb-3">
        <input
          id="aliUrlInput"
          type="url"
          placeholder="https://detail.1688.com/offer/....html"
          class="flex-1 border rounded-lg px-2 py-1 text-sm"
        />
        <button
          type="submit"
          class="px-3 py-1.5 rounded-lg bg-emerald-600 text-white text-sm"
        >
          1688 商品情報を取得
        </button>
      </form>

      <div id="aliUrlResult" class="text-xs text-slate-500"></div>
    </section>


    <section class="bg-white rounded-2xl shadow p-4 md:p-6">
      <h2 class="text-lg font-semibold mb-2">STEP2：楽天利益シミュレーション</h2>
      <p class="text-sm text-slate-600 mb-4">
        選んだ候補商品の仕入れ原価・物流費・楽天手数料をもとに、1商品あたりの利益を試算します。
      </p>

      <form id="profitForm" class="space-y-3">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">
              為替レート（1 CNY = ? JPY）
            </label>
            <input
              id="fxRate"
              type="number"
              step="0.1"
              value="21.0"
              class="w-full border rounded-lg px-2 py-1 text-sm"
            />
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">
              楽天手数料率（概算）
            </label>
            <input
              id="feeRate"
              type="number"
              step="0.01"
              value="0.15"
              class="w-full border rounded-lg px-2 py-1 text-sm"
            />
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">
              商品ID（任意）</label>
            <input
              id="profitProductId"
              type="text"
              class="w-full border rounded-lg px-2 py-1 text-sm"
              placeholder="例）cat1_p1"
            />
          </div>
          <div class="md:col-span-2">
            <label class="block text-xs font-medium text-slate-700 mb-1">
              中国語タイトル</label>
            <input
              id="profitTitleCn"
              type="text"
              class="w-full border rounded-lg px-2 py-1 text-sm"
              placeholder="1688の商品タイトル"
            />
          </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">
              1688 原価（CNY）
            </label>
            <input
              id="costCny"
              type="number"
              step="0.1"
              class="w-full border rounded-lg px-2 py-1 text-sm"
            />
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">
              単位物流費（CNY）
            </label>
            <input
              id="shippingCny"
              type="number"
              step="0.1"
              value="5"
              class="w-full border rounded-lg px-2 py-1 text-sm"
            />
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">
              その他コスト（JPY）
            </label>
            <input
              id="otherFeeJpy"
              type="number"
              step="1"
              value="50"
              class="w-full border rounded-lg px-2 py-1 text-sm"
            />
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">
              楽天販売価格（JPY）
            </label>
            <input
              id="sellPriceJpy"
              type="number"
              step="10"
              value="2480"
              class="w-full border rounded-lg px-2 py-1 text-sm"
            />
          </div>
          <div class="flex items-end">
            <button
              type="submit"
              class="w-full md:w-auto px-4 py-2 rounded-lg bg-emerald-600 text-white text-sm font-medium hover:bg-emerald-500"
            >
              利益を試算する
            </button>
          </div>
        </div>
      </form>

      <div id="profitResult" class="mt-4 text-sm"></div>
    </section>

    <!-- Step 3: 商品ページ文案生成 -->
    <section class="bg-white rounded-2xl shadow p-4 md:p-6 mb-10">
      <h2 class="text-lg font-semibold mb-2">STEP3：楽天商品ページ文案生成</h2>
      <p class="text-sm text-slate-600 mb-4">
        1688 の中国語情報から、楽天向けの日本語タイトル・箇条書き・説明文・検索キーワードを自動生成します。
      </p>

      <form id="listingForm" class="space-y-3">
        <div>
          <label class="block text-xs font-medium text-slate-700 mb-1">
            中国語タイトル</label>
          <input
            id="listingTitleCn"
            type="text"
            class="w-full border rounded-lg px-2 py-1 text-sm"
            placeholder="1688の商品タイトル"
          />
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-700 mb-1">
            中国語の商品説明（任意）</label>
          <textarea
            id="listingDescCn"
            rows="3"
            class="w-full border rounded-lg px-2 py-1 text-sm"
            placeholder="1688の商品説明文（そのまま貼り付けでもOK）"
          ></textarea>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">
              優先して入れたい日本語キーワード（カンマ区切り）</label>
            <input
              id="listingKeywordsJp"
              type="text"
              class="w-full border rounded-lg px-2 py-1 text-sm"
              placeholder="例）キッチン収納, 調味料ラック, 北欧風"
            />
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">
              文体</label>
            <select
              id="listingTone"
              class="w-full border rounded-lg px-2 py-1 text-sm"
            >
              <option value="シンプル">シンプル</option>
              <option value="丁寧">丁寧</option>
              <option value="カジュアル">カジュアル</option>
            </select>
          </div>
        </div>

        <button
          type="submit"
          class="px-4 py-2 rounded-lg bg-indigo-600 text-white text-sm font-medium hover:bg-indigo-500"
        >
          日本語商品ページ文案を生成
        </button>
      </form>

      <div id="listingResult" class="mt-4 text-sm space-y-3"></div>
    </section>
  </main>

  <script>
     const TOKEN_STORAGE_KEY = "rakuten_agent_token_v1";
  let agentToken = localStorage.getItem(TOKEN_STORAGE_KEY) || "";
  
  async function handleStep1() {
  const payload = { /* ... */ };

  const resp = await secureFetch("/market_auto_select", {
    method: "POST",
    body: JSON.stringify(payload),
  });

  if (!resp.ok) {
    throw new Error("HTTP " + resp.status);
  }

  const data = await resp.json();
  // 后面都用 data，而不是再声明 resp
}

async function handleStep2() {
  const payload = { /* ... */ };

  const resp = await secureFetch("/rakuten_profit_simulate", {
    method: "POST",
    body: JSON.stringify(payload),
  });

  if (!resp.ok) {
    throw new Error("HTTP " + resp.status);
  }

  const data = await resp.json();
  // 用 data 渲染界面
}

async function handleStep3() {
  const payload = { /* ... */ };

  const resp = await secureFetch("/rakuten_listing_copy", {
    method: "POST",
    body: JSON.stringify(payload),
  });

  if (!resp.ok) {
    throw new Error("HTTP " + resp.status);
  }

  const data = await resp.json();
  // 用 data.title_jp / data.bullets_jp ... 渲染文案
}

  
  
  
  
  async function ensureToken() {
    if (!agentToken) {
      const input = window.prompt("運営エージェント用パスワードを入力してください：");
      if (!input) {
        throw new Error("パスワードが入力されていません。");
      }
      agentToken = input.trim();
      localStorage.setItem(TOKEN_STORAGE_KEY, agentToken);
    }
  }

  async function secureFetch(url, options = {}) {
    await ensureToken();

    const headers = options.headers || {};
    // 如果没显式指定 Content-Type，默认加上
    if (!headers["Content-Type"] && !(options.body instanceof FormData)) {
      headers["Content-Type"] = "application/json";
    }
    headers["X-Agent-Token"] = agentToken;

    const resp = await fetch(url, { ...options, headers });

    if (resp.status === 401) {
      // 密码错了，清空并提示重输
      localStorage.removeItem(TOKEN_STORAGE_KEY);
      agentToken = "";
      alert("パスワードが間違っています。もう一度お試しください。");
      throw new Error("Unauthorized");
    }

    return resp;
  }


      if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker
        .register("/ui/service-worker.js")
        .then((reg) => {
          console.log("Service Worker registered:", reg.scope);
        })
        .catch((err) => {
          console.log("Service Worker registration failed:", err);
        });
    });
  }

    // 全局变量：保存最近一次自動選品結果，方便带入利润测算/文案
    window.lastAutoSelectResults = [];

    // STEP1: 自動選品
    document.getElementById("autoSelectForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const statusEl = document.getElementById("autoSelectStatus");
      const resultEl = document.getElementById("autoSelectResults");
      statusEl.textContent = "選品中...（/market_auto_select にリクエスト中）";
      resultEl.innerHTML = "";

      const budget = document.getElementById("budgetLevel").value;
      const avoidRaw = document.getElementById("avoidKeywords").value || "";
      const avoidKeywords = avoidRaw
        .split(",")
        .map((s) => s.trim())
        .filter((s) => s.length > 0);

      const topK = parseInt(document.getElementById("topKCategories").value || "3", 10);
      const maxItems = parseInt(document.getElementById("maxItemsPerCategory").value || "20", 10);
      const minPriceCny = parseFloat(document.getElementById("minPriceCny").value || "0");
      const maxPriceCny = parseFloat(document.getElementById("maxPriceCny").value || "9999");

      const payload = {
        budget_level: budget,
        avoid_keywords: avoidKeywords,
        top_k_categories: topK,
        max_items_per_category: maxItems,
        min_price_cny: minPriceCny,
        max_price_cny: maxPriceCny
      };

      try {
      const resp = await secureFetch("/market_auto_select", {
  method: "POST",
  body: JSON.stringify(payload),
});

       if (!resp.ok) {
          throw new Error("HTTP " + resp.status);
        }
        const data = await resp.json();
        window.lastAutoSelectResults = data.results || [];
        statusEl.textContent = "選品完了：" + (window.lastAutoSelectResults.length || 0) + "カテゴリ";

        if (!window.lastAutoSelectResults.length) {
          resultEl.innerHTML = "<div class='text-xs text-red-500'>候補カテゴリが見つかりませんでした。</div>";
          return;
        }

        // 描画
        resultEl.innerHTML = "";
        window.lastAutoSelectResults.forEach((cat, ci) => {
          const div = document.createElement("div");
          div.className = "border rounded-xl p-3";

          const items = cat.items || [];

          let html = `
            <div class="flex items-center justify-between mb-2">
              <div>
                <div class="text-sm font-semibold">${cat.jp_category || "（カテゴリ名なし）"}</div>
                <div class="text-xs text-slate-500">${cat.scene || ""}</div>
              </div>
              <div class="text-[10px] text-slate-500">
                score: ${cat.score ?? ""} ／ ${items.length}件
              </div>
            </div>
            <div class="text-xs text-slate-600 mb-2">${cat.trend_reason || ""}</div>
          `;

          if (!items.length) {
            html += `<div class="text-xs text-slate-400">このカテゴリでは 1688 商品が取得できませんでした。</div>`;
          } else {
            html += `
              <div class="overflow-x-auto">
                <table class="min-w-full text-xs border">
                  <thead class="bg-slate-100">
                    <tr>
                      <th class="border px-2 py-1">ID</th>
                      <th class="border px-2 py-1">中国語タイトル</th>
                      <th class="border px-2 py-1">価格（CNY）</th>
                      <th class="border px-2 py-1">score</th>
                      <th class="border px-2 py-1">操作</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${items
                      .map((it, idx) => {
                        const price = it.price_cny ?? "";
                        const safeTitle = (it.title_cn || "").replace(/"/g, "&quot;");
                        return `
                          <tr>
                            <td class="border px-2 py-1">${it.id || ""}</td>
                            <td class="border px-2 py-1">${safeTitle}</td>
                            <td class="border px-2 py-1 text-right">${price}</td>
                            <td class="border px-2 py-1 text-right">${it.score ?? ""}</td>
                            <td class="border px-2 py-1">
                              <button
                                type="button"
                                class="mb-1 px-2 py-1 rounded bg-emerald-600 text-white text-[11px]"
                                onclick="useForProfit(${ci}, ${idx})"
                              >
                                利益試算に使用
                              </button>
                              <button
                                type="button"
                                class="px-2 py-1 rounded bg-indigo-600 text-white text-[11px]"
                                onclick="useForListing(${ci}, ${idx})"
                              >
                                文案生成に使用
                              </button>
                            </td>
                          </tr>
                        `;
                      })
                      .join("")}
                  </tbody>
                </table>
              </div>
            `;
          }

          div.innerHTML = html;
          resultEl.appendChild(div);
        });
      } catch (err) {
        console.error(err);
        statusEl.textContent = "選品に失敗しました：" + err;
        resultEl.innerHTML = "<div class='text-xs text-red-500'>サーバーエラーが発生しました。コンソールログを確認してください。</div>";
      }
    });

    // STEP1 → STEP2/3 連携用：利益試算に持っていく
    window.useForProfit = function (catIndex, itemIndex) {
      const cat = window.lastAutoSelectResults[catIndex];
      if (!cat) return;
      const item = (cat.items || [])[itemIndex];
      if (!item) return;

      document.getElementById("profitProductId").value =
        (cat.jp_category || "cat") + "_" + (item.id || ("i" + itemIndex));
      document.getElementById("profitTitleCn").value = item.title_cn || "";
      document.getElementById("costCny").value = item.price_cny ?? "";
    };

    window.useForListing = function (catIndex, itemIndex) {
      const cat = window.lastAutoSelectResults[catIndex];
      if (!cat) return;
      const item = (cat.items || [])[itemIndex];
      if (!item) return;

      document.getElementById("listingTitleCn").value = item.title_cn || "";
      // desc は一旦空、必要なら手動で 1688 からコピペ
      document.getElementById("listingDescCn").value = "";
      // カテゴリ名から軽くキーワードを入れておく
      document.getElementById("listingKeywordsJp").value =
        (cat.jp_category || "").replace("Amazon｜", "").replace(/[（）\(\)]/g, " ");
    };

    // STEP2: 利益シミュレーション
    document.getElementById("profitForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const resultEl = document.getElementById("profitResult");
      resultEl.textContent = "計算中...";

      const fxRate = parseFloat(document.getElementById("fxRate").value || "21");
      const feeRate = parseFloat(document.getElementById("feeRate").value || "0.15");

      const productId = document.getElementById("profitProductId").value || "p1";
      const titleCn = document.getElementById("profitTitleCn").value || "";

      const costCny = parseFloat(document.getElementById("costCny").value || "0");
      const shippingCny = parseFloat(document.getElementById("shippingCny").value || "0");
      const otherFeeJpy = parseFloat(document.getElementById("otherFeeJpy").value || "0");
      const sellPriceJpy = parseFloat(document.getElementById("sellPriceJpy").value || "0");

      const payload = {
        fx_rate: fxRate,
        rakuten_fee_rate: feeRate,
        items: [
          {
            product_id: productId,
            title_cn: titleCn,
            cost_cny: costCny,
            shipping_cny: shippingCny,
            sell_price_jpy: sellPriceJpy,
            other_fee_jpy: otherFeeJpy
          }
        ]
      };

      try {
       const resp = await secureFetch("/rakuten_profit_simulate", {
  method: "POST",
  body: JSON.stringify(payload),
});

        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();

        const item = (data.items || [])[0];
        if (!item) {
          resultEl.innerHTML = "<div class='text-xs text-red-500'>計算結果が空です。</div>";
          return;
        }

        resultEl.innerHTML = `
          <div class="border rounded-xl p-3 bg-slate-50">
            <div class="text-xs text-slate-500 mb-1">商品ID：${item.product_id}</div>
            <div class="text-sm font-medium mb-1">${item.title_cn || ""}</div>
            <div class="text-xs space-y-1">
              <div>総コスト：<span class="font-semibold">${item.cost_total_jpy}</span> 円（原価＋物流＋その他）</div>
              <div>楽天手数料（概算）：<span class="font-semibold">${item.rakuten_fee_jpy}</span> 円</div>
              <div>1件あたり粗利：<span class="font-semibold">${item.gross_profit_jpy}</span> 円</div>
              <div>利益率：<span class="font-semibold">${(item.margin * 100).toFixed(1)}%</span></div>
              <div class="mt-1 text-emerald-700">${item.advice}</div>
            </div>
          </div>
        `;
      } catch (err) {
        console.error(err);
        resultEl.innerHTML = "<div class='text-xs text-red-500'>利益シミュレーションに失敗しました：" + err + "</div>";
      }
    });

    // STEP3: 楽天商品ページ文案生成
    document.getElementById("listingForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const resultEl = document.getElementById("listingResult");
      resultEl.textContent = "生成中...";

      const titleCn = document.getElementById("listingTitleCn").value || "";
      const descCn = document.getElementById("listingDescCn").value || "";
      const kwRaw = document.getElementById("listingKeywordsJp").value || "";
      const tone = document.getElementById("listingTone").value || "シンプル";

      const keywordsJp = kwRaw
        .split(",")
        .map((s) => s.trim())
        .filter((s) => s.length > 0);

      const payload = {
        title_cn: titleCn,
        desc_cn: descCn,
        keywords_jp: keywordsJp,
        shop_tone: tone
      };

      try {
        const resp = await secureFetch("/rakuten_listing_copy", {
  method: "POST",
  body: JSON.stringify(payload),
});

        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();

        if (data.raw_text) {
          resultEl.innerHTML = `
            <div class="border rounded-xl p-3 bg-slate-50">
              <div class="text-xs text-red-500 mb-2">JSON 解析に失敗したため、生テキストを表示します。</div>
              <pre class="whitespace-pre-wrap text-xs">${data.raw_text}</pre>
            </div>
          `;
          return;
        }

        resultEl.innerHTML = `
          <div class="border rounded-xl p-3 bg-slate-50 space-y-2">
            <div>
              <div class="text-xs font-semibold text-slate-600 mb-1">楽天用タイトル</div>
              <div class="text-sm">${data.title_jp || ""}</div>
            </div>
            <div>
              <div class="text-xs font-semibold text-slate-600 mb-1">箇条書き（売りポイント）</div>
              <ul class="list-disc list-inside text-sm">
                ${(data.bullets_jp || [])
                  .map((b) => `<li>${b}</li>`)
                  .join("")}
              </ul>
            </div>
            <div>
              <div class="text-xs font-semibold text-slate-600 mb-1">商品説明文</div>
              <div class="text-sm whitespace-pre-wrap">${data.description_jp || ""}</div>
            </div>
            <div>
              <div class="text-xs font-semibold text-slate-600 mb-1">検索キーワード候補</div>
              <div class="text-xs">
                ${(data.search_keywords_jp || []).join(" / ")}
              </div>
            </div>
          </div>
        `;
      } catch (err) {
        console.error(err);
        resultEl.innerHTML = "<div class='text-xs text-red-500'>文案生成に失敗しました：" + err + "</div>";
      }
    });

    

  // ... 这里已经有 secureFetch / 各种事件监听，不动它们 ...

  // ===== 1688 URL インポート（PC用） =====
  let lastParsed1688Item = null;

  const aliUrlForm = document.getElementById("aliUrlForm");
  if (aliUrlForm) {
    aliUrlForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const urlInput = document.getElementById("aliUrlInput");
      const url = (urlInput.value || "").trim();
      const resultEl = document.getElementById("aliUrlResult");

      if (!url) {
        resultEl.innerHTML =
          "<div class='text-xs text-red-500'>1688 の商品URLを入力してください。</div>";
        return;
      }

      resultEl.innerHTML =
        "<div class='text-xs text-slate-500'>解析中...</div>";

      try {
        const resp = await secureFetch("/ali1688/parse_url", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url }),
        });

        if (!resp.ok) {
          const errJson = await resp.json().catch(() => null);
          const msg = errJson?.detail || ("HTTP " + resp.status);
          throw new Error(msg);
        }

        const data = await resp.json();
        lastParsed1688Item = data;

        resultEl.innerHTML = `
          <div class="border border-emerald-200 rounded-lg p-3 text-xs space-y-2">
            <div class="font-semibold text-slate-800 mb-1">解析結果</div>
            <div><span class="font-medium">タイトル（CN）：</span>${data.title_cn || "(取得できませんでした)"}</div>
            <div><span class="font-medium">価格（CNY）：</span>${data.price_cny ?? "(不明)"}</div>
            <div class="flex flex-wrap gap-2 mt-1">
              <button type="button"
                class="px-2 py-1 rounded bg-emerald-600 text-white"
                onclick="applyParsed1688ToProfit()">
                利益試算に反映
              </button>
              <button type="button"
                class="px-2 py-1 rounded bg-indigo-600 text-white"
                onclick="applyParsed1688ToListing()">
                文案生成に反映
              </button>
            </div>
          </div>
        `;
      } catch (err) {
        console.error(err);
        resultEl.innerHTML =
          "<div class='text-xs text-red-500'>解析に失敗しました：" + err + "</div>";
      }
    });
  }

  window.applyParsed1688ToProfit = function () {
    if (!lastParsed1688Item) return;
    const it = lastParsed1688Item;
    const titleInput = document.getElementById("profitTitleCn");
    const costInput = document.getElementById("costCny");

    if (titleInput && it.title_cn) {
      titleInput.value = it.title_cn;
    }
    if (costInput && typeof it.price_cny === "number") {
      costInput.value = it.price_cny;
    }
  };

  window.applyParsed1688ToListing = function () {
    if (!lastParsed1688Item) return;
    const it = lastParsed1688Item;
    const titleInput = document.getElementById("listingTitleCn");
    if (titleInput && it.title_cn) {
      titleInput.value = it.title_cn;
    }
  };
  </script>
</body>
</html>
