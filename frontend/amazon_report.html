<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Amazon店舗レポート（楽天展開候補）</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px 24px 40px;
      background: #f5f5f7;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 8px;
    }
    h2 {
      font-size: 16px;
      margin: 16px 0 8px;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    }
    label {
      font-size: 13px;
      margin-right: 8px;
    }
    input[type="text"],
    input[type="password"] {
      padding: 4px 8px;
      font-size: 13px;
      border-radius: 4px;
      border: 1px solid #ccc;
      margin-right: 8px;
    }
    button {
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: #2563eb;
      color: #fff;
    }
    button[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: #6b7280;
    }
    #auth-status {
      font-size: 12px;
      margin-left: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      background: #fff;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #f3f4f6;
      white-space: nowrap;
    }
    .text-right {
      text-align: right;
    }
    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      background: #e5e7eb;
      margin-right: 4px;
    }
    .tag-A { background: #16a34a; color: #fff; }
    .tag-B { background: #2563eb; color: #fff; }
    .tag-C { background: #6b7280; color: #fff; }
    .small {
      font-size: 11px;
      color: #6b7280;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .toolbar-group {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      align-items: center;
    }
  </style>
</head>
<body>
  <h1>Amazon店舗レポート & 楽天展開候補</h1>
  <p class="small">
    HT株式会社 Amazon 店舗の売上データ（CSV → JSON）をもとに、
    「楽天に横展開すべきSKU候補」を一覧化します。
  </p>

  <!-- 認証カード -->
  <div class="card">
    <h2>アクセスパスワード</h2>
    <div class="toolbar">
      <div class="toolbar-group">
        <label for="token-input">パスワード:</label>
        <input type="password" id="token-input" placeholder="Render で設定した AGENT_ACCESS_TOKEN" />
        <button id="btn-save-token" class="btn-secondary">保存 & 接続テスト</button>
        <span id="auth-status"></span>
      </div>
      <div class="small">
        ※ 一度保存するとブラウザのローカルに保持されます（再入力不要）。
      </div>
    </div>
  </div>

  <!-- 条件入力カード -->
  <div class="card">
    <h2>分析条件</h2>
    <div class="toolbar">
      <div class="toolbar-group">
        <label for="shop-id">Shop ID:</label>
        <input type="text" id="shop-id" value="ht_amazon_main" />
      </div>
      <div class="toolbar-group">
        <label for="target-month">対象月 (YYYY-MM):</label>
        <input type="text" id="target-month" value="2025-11" />
        <span class="small">※ 空欄なら全期間</span>
      </div>
      <button id="btn-run-analysis">分析を実行</button>
    </div>
    <div id="run-status" class="small" style="margin-top:8px;"></div>
  </div>

  <!-- サマリカード -->
  <div id="summary-card" class="card" style="display:none;">
    <h2>全体サマリ</h2>
    <div id="summary-content"></div>
  </div>

  <!-- 楽天展開候補カード -->
  <div id="candidates-card" class="card" style="display:none;">
    <div class="toolbar" style="justify-content: space-between; margin-bottom:8px;">
      <h2 style="margin:0;">楽天展開候補 SKU 一覧</h2>
      <button id="btn-download-candidates-csv" disabled>候補SKU CSV ダウンロード</button>
    </div>
    <div id="candidates-content"></div>
  </div>

  <script>
    // ===== 認証ヘルパー =====
    const TOKEN_KEY = "x_agent_token";

    function getToken() {
      try {
        return localStorage.getItem(TOKEN_KEY) || "";
      } catch (e) {
        return "";
      }
    }

    function setToken(token) {
      try {
        localStorage.setItem(TOKEN_KEY, token || "");
      } catch (e) {
        console.warn("failed to store token", e);
      }
    }

    async function secureFetch(url, options = {}) {
      const token = getToken();
      const headers = new Headers(options.headers || {});
      if (token) {
        headers.set("X-Agent-Token", token);
      }
      return fetch(url, {
        ...options,
        headers,
      });
    }

    // ===== UI 状態 =====
    let lastResult = null;

    const elTokenInput = document.getElementById("token-input");
    const elAuthStatus = document.getElementById("auth-status");
    const elRunStatus = document.getElementById("run-status");
    const elSummaryCard = document.getElementById("summary-card");
    const elSummaryContent = document.getElementById("summary-content");
    const elCandidatesCard = document.getElementById("candidates-card");
    const elCandidatesContent = document.getElementById("candidates-content");
    const elBtnDownloadCsv = document.getElementById("btn-download-candidates-csv");

    // 初期化：保存済みトークンがあれば入力欄に反映
    (function initAuth() {
      const t = getToken();
      if (t) {
        elTokenInput.value = t;
        elAuthStatus.textContent = "保存済み";
        elAuthStatus.style.color = "#16a34a";
      }
    })();

    // トークン保存 & /auth/check 呼び出し
    document.getElementById("btn-save-token").addEventListener("click", async () => {
      const token = elTokenInput.value.trim();
      if (!token) {
        elAuthStatus.textContent = "パスワードを入力してください";
        elAuthStatus.style.color = "#b91c1c";
        return;
      }
      setToken(token);
      elAuthStatus.textContent = "接続テスト中...";
      elAuthStatus.style.color = "#4b5563";

      try {
        const res = await secureFetch("/auth/check");
        if (!res.ok) throw new Error("status " + res.status);
        const data = await res.json();
        if (data.ok) {
          elAuthStatus.textContent = "接続OK";
          elAuthStatus.style.color = "#16a34a";
        } else {
          elAuthStatus.textContent = "パスワードが正しくありません";
          elAuthStatus.style.color = "#b91c1c";
        }
      } catch (e) {
        console.error(e);
        elAuthStatus.textContent = "接続エラー";
        elAuthStatus.style.color = "#b91c1c";
      }
    });

    // ===== Amazon 分析実行 =====
    document.getElementById("btn-run-analysis").addEventListener("click", async () => {
      const shopId = document.getElementById("shop-id").value.trim();
      const ym = document.getElementById("target-month").value.trim();

      if (!shopId) {
        alert("Shop ID を入力してください。");
        return;
      }

      elRunStatus.textContent = "分析中…";
      elRunStatus.style.color = "#4b5563";
      elBtnDownloadCsv.disabled = true;
      lastResult = null;

      try {
        const res = await secureFetch("/amazon/analysis/summary", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            shop_id: shopId,
            target_month: ym || null,
          }),
        });

        if (!res.ok) {
          throw new Error("API error status=" + res.status);
        }

        const data = await res.json();

        if (!data.ok) {
          elRunStatus.textContent = data.message || "データが見つかりませんでした。";
          elRunStatus.style.color = "#b91c1c";
          elSummaryCard.style.display = "none";
          elCandidatesCard.style.display = "none";
          return;
        }

        lastResult = data;
        elRunStatus.textContent = "分析完了";
        elRunStatus.style.color = "#16a34a";

        renderSummary(data.summary || {});
        renderCandidates(data.rakuten_candidates || []);

      } catch (e) {
        console.error(e);
        elRunStatus.textContent = "分析に失敗しました。コンソールを確認してください。";
        elRunStatus.style.color = "#b91c1c";
        elSummaryCard.style.display = "none";
        elCandidatesCard.style.display = "none";
      }
    });

    function renderSummary(summary) {
      elSummaryCard.style.display = "block";

      const totalSales = Math.round(summary.total_sales_jpy || 0);
      const totalUnits = summary.total_units || 0;
      const asinCount = summary.asin_count || 0;

      elSummaryContent.innerHTML = `
        <p>売上合計：<strong>${totalSales.toLocaleString()} 円</strong></p>
        <p>販売数合計：<strong>${totalUnits.toLocaleString()} 個</strong></p>
        <p>ASIN 数：<strong>${asinCount}</strong></p>
      `;
    }

    function renderCandidates(list) {
      if (!list || list.length === 0) {
        elCandidatesCard.style.display = "block";
        elCandidatesContent.innerHTML = `<p class="small">楽天展開候補 SKU がありません。</p>`;
        elBtnDownloadCsv.disabled = true;
        return;
      }

      lastResult.rakuten_candidates = list;
      elCandidatesCard.style.display = "block";
      elBtnDownloadCsv.disabled = false;

      let html = `
        <table>
          <thead>
            <tr>
              <th>ASIN</th>
              <th>商品名</th>
              <th class="text-right">Amazon売上(円)</th>
              <th class="text-right">販売数</th>
              <th>ランク</th>
              <th class="text-right">CVR</th>
              <th>楽天展開理由</th>
            </tr>
          </thead>
          <tbody>
      `;

      for (const r of list) {
        const sales = Math.round(r.amazon_sales_jpy || 0);
        const units = r.units || 0;
        const rank = r.sales_rank || "";
        const cvr = r.conversion_rate != null
          ? (r.conversion_rate * 100).toFixed(1) + "%"
          : "-";
        const reason = r.reason || "";

        const rankClass =
          rank === "A" ? "tag tag-A" :
          rank === "B" ? "tag tag-B" :
          rank === "C" ? "tag tag-C" :
          "tag";

        html += `
          <tr>
            <td>${r.asin || ""}</td>
            <td>${r.title || ""}</td>
            <td class="text-right">${sales.toLocaleString()}</td>
            <td class="text-right">${units}</td>
            <td><span class="${rankClass}">${rank || "-"}</span></td>
            <td class="text-right">${cvr}</td>
            <td>${reason}</td>
          </tr>
        `;
      }

      html += "</tbody></table>";
      elCandidatesContent.innerHTML = html;
    }

    // ===== CSV ダウンロード（UTF-8 BOM 付き） =====
    elBtnDownloadCsv.addEventListener("click", () => {
      if (!lastResult || !lastResult.rakuten_candidates || lastResult.rakuten_candidates.length === 0) {
        alert("先に分析を実行してください。");
        return;
      }

      const rows = lastResult.rakuten_candidates;
      const headers = [
        "asin",
        "title",
        "amazon_sales_jpy",
        "units",
        "sales_rank",
        "conversion_rate",
        "reason"
      ];

      let csv = "";
      csv += headers.join(",") + "\n";

      for (const r of rows) {
        const asin = r.asin || "";
        const title = (r.title || "").replace(/"/g, '""'); // CSV 用エスケープ
        const sales = r.amazon_sales_jpy != null ? r.amazon_sales_jpy : "";
        const units = r.units != null ? r.units : "";
        const rank = r.sales_rank || "";
        const cvr = r.conversion_rate != null ? r.conversion_rate : "";
        const reason = (r.reason || "").replace(/"/g, '""');

        const line = [
          asin,
          `"${title}"`,
          sales,
          units,
          rank,
          cvr,
          `"${reason}"`
        ].join(",");
        csv += line + "\n";
      }

      // ★ ここがポイント：UTF-8 BOM を先頭に付ける
      const bom = "\uFEFF";
      const blob = new Blob([bom + csv], {
        type: "text/csv;charset=utf-8;"
      });

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "rakuten_candidates.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
