<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>楽天エージェント（モバイル）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#020617" />
  <link rel="manifest" href="/ui/manifest.webmanifest" />
  <!-- Tailwind CDN（開発〜MVP用途） -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-slate-50 min-h-screen">
  <!-- ヘッダー -->
  <header class="px-4 py-3 flex items-center justify-between bg-slate-950 border-b border-slate-800">
    <div>
      <div class="text-sm font-semibold">楽天選品・運営エージェント</div>
      <div class="text-[11px] text-slate-400">モバイル版ワークフロー</div>
    </div>
    <a
      href="/ui/"
      class="text-[11px] px-2 py-1 rounded-lg border border-slate-700 text-slate-300"
    >
      PC版へ
    </a>
  </header>

  <!-- ステップナビ -->
  <nav class="px-4 py-2 bg-slate-900 border-b border-slate-800">
    <div class="flex items-center justify-between text-[11px]">
      <button
        id="stepBtn1"
        class="flex-1 mr-1 px-2 py-1 rounded-lg font-medium bg-emerald-600 text-white"
        onclick="showStep(1)"
      >
        STEP1 選品
      </button>
      <button
        id="stepBtn2"
        class="flex-1 mx-1 px-2 py-1 rounded-lg bg-slate-800 text-slate-200"
        onclick="showStep(2)"
      >
        STEP2 利益
      </button>
      <button
        id="stepBtn3"
        class="flex-1 ml-1 px-2 py-1 rounded-lg bg-slate-800 text-slate-200"
        onclick="showStep(3)"
      >
        STEP3 文案
      </button>
    </div>
  </nav>

  <!-- メインコンテンツ -->
  <main class="pb-20">
    <!-- STEP1: 自動選品 -->
    <section id="step1" class="px-4 py-3 space-y-3">
      <h2 class="text-sm font-semibold mb-1">STEP1：自動選品</h2>
      <p class="text-xs text-slate-400 mb-2">
        楽天＋Amazonトレンドからカテゴリを選び、1688 から候補商品を取得します。
      </p>

      <form id="autoSelectFormMobile" class="space-y-3">
        <div>
          <label class="block text-xs font-medium text-slate-300 mb-1">
            資金レベル（客単価帯）
          </label>
          <select
            id="budgetLevelMobile"
            class="w-full rounded-lg bg-slate-900 border border-slate-700 px-2 py-1 text-xs"
          >
            <option value="low">低め（〜3,000円中心）</option>
            <option value="mid">中〜高（3,000〜8,000円）</option>
            <option value="high">高単価（8,000円〜）</option>
          </select>
        </div>

        <div>
          <label class="block text-xs font-medium text-slate-300 mb-1">
            避けたいジャンルキーワード（日文・カンマ区切り）
          </label>
          <input
            id="avoidKeywordsInputMobile"
            type="text"
            class="w-full rounded-md border border-slate-600 bg-white px-2 py-1 text-xs text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-emerald-500"
            placeholder="避けたいジャンル"
          />
          <p class="mt-1 text-[10px] text-slate-400">
            例：ベビー、食品
          </p>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="block text-xs font-medium text-slate-300 mb-1">
              カテゴリ数（top_k）
            </label>
            <input
              id="topKCategoriesMobile"
              type="number"
              min="1"
              max="10"
              value="3"
              class="w-full rounded-lg bg-slate-900 border border-slate-700 px-2 py-1 text-xs"
            />
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-300 mb-1">
              仕入れ価格帯（CNY）
            </label>
            <div class="flex items-center space-x-1">
              <input
                id="minPriceCnyMobile"
                type="number"
                min="0"
                value="5"
                class="w-1/2 rounded-lg bg-slate-900 border border-slate-700 px-2 py-1 text-xs"
              />
              <span class="text-xs text-slate-400">〜</span>
              <input
                id="maxPriceCnyMobile"
                type="number"
                min="0"
                value="40"
                class="w-1/2 rounded-lg bg-slate-900 border border-slate-700 px-2 py-1 text-xs"
              />
            </div>
          </div>
        </div>

        <button
          type="submit"
          class="w-full py-2 rounded-xl bg-emerald-600 text-xs font-semibold text-white mt-1"
        >
          自動選品を実行する
        </button>
      </form>

      <p id="autoSelectStatusMobile" class="text-[11px] text-slate-400 mt-1"></p>
      <div id="autoSelectResultsMobile" class="space-y-3 mt-2 text-xs"></div>

      <!-- STEP1.5: 1688 URL インポート（このブロックはSTEP1の中に1回だけ） -->
      <section id="step1_5" class="mt-4 space-y-2">
        <h2 class="text-sm font-semibold">STEP1.5：1688 商品URLインポート（半自動）</h2>
        <p class="text-xs text-slate-400">
          1688 で目視選定した商品のURLを貼り付けて、タイトルと仕入れ単価を取得します。
          ブロックされた場合はブラウザで開き、人力コピーしてください。
        </p>

        <form id="aliUrlFormMobile" class="flex flex-col gap-2">
          <input
            id="aliUrlInputMobile"
            type="url"
            class="w-full rounded-lg px-3 py-2 text-sm bg-slate-900 border border-slate-700"
            placeholder="https://detail.1688.com/offer/....html"
          />
          <button
            type="submit"
            class="w-full py-2 rounded-lg bg-emerald-500 text-sm font-semibold text-slate-950"
          >
            1688 商品情報を取得
          </button>
        </form>

        <div id="aliUrlResultMobile" class="text-xs text-slate-400"></div>
      </section>
    </section>

    <!-- STEP2: 利益シミュレーション -->
    <section id="step2" class="px-4 py-3 hidden space-y-3">
      <h2 class="text-sm font-semibold mb-1">STEP2：楽天利益シミュレーション</h2>
      <p class="text-xs text-slate-400 mb-2">
        STEP1 で選んだ商品をもとに、1件あたりの粗利・利益率を試算します。
      </p>

      <form id="profitFormMobile" class="space-y-2">
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="block text-[11px] font-medium text-slate-300 mb-1">
              為替レート（1 CNY = ? JPY）
            </label>
            <input
              id="fxRateMobile"
              type="number"
              step="0.1"
              value="21.0"
              class="w-full rounded-lg bg-slate-900 border border-slate-700 px-2 py-1 text-xs"
            />
          </div>
          <div>
            <label class="block text-[11px] font-medium text-slate-300 mb-1">
              楽天手数料率（概算）
            </label>
            <input
              id="feeRateMobile"
              type="number"
              step="0.01"
              value="0.15"
              class="w-full rounded-lg bg-slate-900 border border-slate-700 px-2 py-1 text-xs"
            />
          </div>
        </div>

        <div>
          <label class="block text-[11px] font-medium text-slate-300 mb-1">
            商品ID（任意）
          </label>
          <input
            id="profitProductIdMobile"
            type="text"
            class="w-full rounded-lg bg-slate-900 border border-slate-700 px-2 py-1 text-xs"
            placeholder="例）cat1_p1"
          />
        </div>

        <div>
          <label class="block text-[11px] font-medium text-slate-300 mb-1">
            中国語タイトル
          </label>
          <textarea
            id="profitTitleCnMobile"
            rows="2"
            class="w-full rounded-lg bg-slate-900 border border-slate-700 px-2 py-1 text-xs"
            placeholder="STEP1からボタンで自動入力されます"
          ></textarea>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="block text-[11px] font-medium text-slate-300 mb-1">
              1688 原価（CNY）
            </label>
            <input
              id="costCnyMobile"
              type="number"
              step="0.1"
              class="w-full rounded-lg bg-slate-900 border border-slate-700 px-2 py-1 text-xs"
            />
          </div>
          <div>
            <label class="block text-[11px] font-medium text-slate-300 mb-1">
              単位物流費（CNY）
            </label>
            <input
              id="shippingCnyMobile"
              type="number"
              step="0.1"
              value="5"
              class="w-full rounded-lg bg-slate-900 border border-slate-700 px-2 py-1 text-xs"
            />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="block text-[11px] font-medium text-slate-300 mb-1">
              その他コスト（JPY）
            </label>
            <input
              id="otherFeeJpyMobile"
              type="number"
              step="1"
              value="50"
              class="w-full rounded-lg bg-slate-900 border border-slate-700 px-2 py-1 text-xs"
            />
          </div>
          <div>
            <label class="block text-[11px] font-medium text-slate-300 mb-1">
              楽天販売価格（JPY）
            </label>
            <input
              id="sellPriceJpyMobile"
              type="number"
              step="10"
              value="2480"
              class="w-full rounded-lg bg-slate-900 border border-slate-700 px-2 py-1 text-xs"
            />
          </div>
        </div>

        <button
          type="submit"
          class="w-full py-2 rounded-xl bg-emerald-600 text-xs font-semibold text-white mt-1"
        >
          利益を試算する
        </button>
      </form>

      <div id="profitResultMobile" class="mt-3 text-xs"></div>
    </section>

    <!-- STEP3: 商品ページ文案生成 -->
    <section id="step3" class="px-4 py-3 hidden space-y-3">
      <h2 class="text-sm font-semibold mb-1">STEP3：楽天商品ページ文案生成</h2>
      <p class="text-xs text-slate-400 mb-2">
        1688 の中国語情報から、楽天向け日本語タイトル・箇条書き・説明文を生成します。
      </p>

      <form id="listingFormMobile" class="space-y-2">
        <div>
          <label class="block text-[11px] font-medium text-slate-300 mb-1">
            中国語タイトル
          </label>
          <textarea
            id="listingTitleCnMobile"
            rows="2"
            class="w-full rounded-lg bg-slate-900 border border-slate-700 px-2 py-1 text-xs"
            placeholder="STEP1からボタンで自動入力されます"
          ></textarea>
        </div>
        <div>
          <label class="block text-[11px] font-medium text-slate-300 mb-1">
            中国語の商品説明（任意）
          </label>
          <textarea
            id="listingDescCnMobile"
            rows="3"
            class="w-full rounded-lg bg-slate-900 border border-slate-700 px-2 py-1 text-xs"
            placeholder="1688の商品説明文をそのまま貼り付けてもOKです"
          ></textarea>
        </div>

        <div>
          <label class="block text-[11px] font-medium text-slate-300 mb-1">
            優先して入れたい日本語キーワード（カンマ区切り）
          </label>
          <input
            id="listingKeywordsJpMobile"
            type="text"
            class="w-full rounded-lg bg-slate-900 border border-slate-700 px-2 py-1 text-xs"
            placeholder="例）キッチン収納, 調味料ラック, 北欧風"
          />
        </div>

        <div>
          <label class="block text-[11px] font-medium text-slate-300 mb-1">
            文体
          </label>
          <select
            id="listingToneMobile"
            class="w-full rounded-lg bg-slate-900 border border-slate-700 px-2 py-1 text-xs"
          >
            <option value="シンプル">シンプル</option>
            <option value="丁寧">丁寧</option>
            <option value="カジュアル">カジュアル</option>
          </select>
        </div>

        <button
          type="submit"
          class="w-full py-2 rounded-xl bg-indigo-600 text-xs font-semibold text-white mt-1"
        >
          日本語商品ページ文案を生成
        </button>
      </form>

      <div id="listingResultMobile" class="mt-3 text-xs space-y-2"></div>
    </section>
  </main>

  <script>
    // ====== 共通：Token & secureFetch ======
    const TOKEN_STORAGE_KEY = "rakuten_agent_token_v1";
    let agentToken = localStorage.getItem(TOKEN_STORAGE_KEY) || "";

    async function ensureToken() {
      if (!agentToken) {
        const input = window.prompt("運営エージェント用パスワードを入力してください：");
        if (!input) {
          throw new Error("パスワードが入力されていません。");
        }
        agentToken = input.trim();
        localStorage.setItem(TOKEN_STORAGE_KEY, agentToken);
      }
    }

    async function secureFetch(url, options = {}) {
      await ensureToken();

      const headers = options.headers || {};
      if (!headers["Content-Type"] && !(options.body instanceof FormData)) {
        headers["Content-Type"] = "application/json";
      }
      headers["X-Agent-Token"] = agentToken;

      const resp = await fetch(url, { ...options, headers });

      if (resp.status === 401) {
        localStorage.removeItem(TOKEN_STORAGE_KEY);
        agentToken = "";
        alert("パスワードが間違っています。もう一度お試しください。");
        throw new Error("Unauthorized");
      }

      return resp;
    }

    // ====== PWA: Service Worker ======
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("/ui/service-worker.js")
          .then((reg) => {
            console.log("Service Worker registered (mobile):", reg.scope);
          })
          .catch((err) => {
            console.log("Service Worker registration failed (mobile):", err);
          });
      });
    }

    // ====== ステップ切り替え ======
    function showStep(step) {
      const s1 = document.getElementById("step1");
      const s2 = document.getElementById("step2");
      const s3 = document.getElementById("step3");
      const b1 = document.getElementById("stepBtn1");
      const b2 = document.getElementById("stepBtn2");
      const b3 = document.getElementById("stepBtn3");

      s1.classList.toggle("hidden", step !== 1);
      s2.classList.toggle("hidden", step !== 2);
      s3.classList.toggle("hidden", step !== 3);

      const active = "bg-emerald-600 text-white";
      const inactive = "bg-slate-800 text-slate-200";

      [b1, b2, b3].forEach((b) => {
        b.classList.remove("bg-emerald-600","text-white","bg-slate-800","text-slate-200");
        b.classList.add(inactive);
      });

      if (step === 1) {
        b1.classList.remove(inactive);
        b1.classList.add(active);
      } else if (step === 2) {
        b2.classList.remove(inactive);
        b2.classList.add(active);
      } else {
        b3.classList.remove(inactive);
        b3.classList.add(active);
      }
    }

    // ====== STEP1: 自動選品 ======
    window.lastAutoSelectResultsMobile = [];

    document.getElementById("autoSelectFormMobile").addEventListener("submit", async (e) => {
      e.preventDefault();
      const statusEl = document.getElementById("autoSelectStatusMobile");
      const resultEl = document.getElementById("autoSelectResultsMobile");
      statusEl.textContent = "選品中…（/market_auto_select にリクエスト中）";
      resultEl.innerHTML = "";

      const budget = document.getElementById("budgetLevelMobile").value;
      const avoidInput = document.getElementById("avoidKeywordsInputMobile");
      const avoidRaw = (avoidInput && avoidInput.value) || "";
      const avoidKeywords = avoidRaw
        .split(/[,，、\s]+/)
        .map((s) => s.trim())
        .filter((s) => s.length > 0);

      const topK = parseInt(document.getElementById("topKCategoriesMobile").value || "3", 10);
      const minPriceCny = parseFloat(document.getElementById("minPriceCnyMobile").value || "0");
      const maxPriceCny = parseFloat(document.getElementById("maxPriceCnyMobile").value || "9999");

      const payload = {
        budget_level: budget,
        avoid_keywords: avoidKeywords,
        top_k_categories: topK,
        max_items_per_category: 20,
        min_price_cny: minPriceCny,
        max_price_cny: maxPriceCny
      };

      try {
        const resp = await secureFetch("/market_auto_select", {
          method: "POST",
          body: JSON.stringify(payload),
        });

        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        window.lastAutoSelectResultsMobile = data.results || [];
        statusEl.textContent = "選品完了：" + (window.lastAutoSelectResultsMobile.length || 0) + "カテゴリ";

        if (!window.lastAutoSelectResultsMobile.length) {
          resultEl.innerHTML = "<div class='text-[11px] text-red-400'>候補カテゴリが見つかりませんでした。</div>";
          return;
        }

        resultEl.innerHTML = "";
        window.lastAutoSelectResultsMobile.forEach((cat, ci) => {
          const items = cat.items || [];
          const wrapper = document.createElement("div");
          wrapper.className = "rounded-2xl border border-slate-800 bg-slate-900 p-3";

          let html = `
            <div class="flex items-start justify-between mb-2">
              <div>
                <div class="text-xs font-semibold">${cat.jp_category || "（カテゴリ名なし）"}</div>
                <div class="text-[11px] text-slate-400">${cat.scene || ""}</div>
              </div>
              <div class="text-[10px] text-slate-500 text-right">
                score: ${cat.score ?? ""}<br/>
                ${items.length}件
              </div>
            </div>
            <div class="text-[11px] text-slate-400 mb-2">${cat.trend_reason || ""}</div>
          `;

          if (!items.length) {
            html += `<div class="text-[11px] text-slate-500">このカテゴリでは 1688 商品が取得できませんでした。</div>`;
          } else {
            html += `<div class="space-y-2">`;
            items.slice(0, 5).forEach((it, idx) => {
              const safeTitle = (it.title_cn || "");
              html += `
                <div class="rounded-xl border border-slate-800 bg-slate-950 px-2 py-2">
                  <div class="text-[10px] text-slate-500 mb-0.5">ID: ${it.id || ""}</div>
                  <div class="text-[11px] mb-0.5">${safeTitle}</div>
                  <div class="flex items-center justify-between text-[11px] text-slate-400">
                    <span>価格: ${it.price_cny ?? ""} CNY ／ score: ${it.score ?? ""}</span>
                  </div>
                  <div class="mt-1 flex space-x-2">
                    <button
                      type="button"
                      class="flex-1 py-1 rounded-lg bg-emerald-600 text-[11px] text-white"
                      onclick="useForProfitMobile(${ci}, ${idx})"
                    >
                      利益試算へ
                    </button>
                    <button
                      type="button"
                      class="flex-1 py-1 rounded-lg bg-indigo-600 text-[11px] text-white"
                      onclick="useForListingMobile(${ci}, ${idx})"
                    >
                      文案生成へ
                    </button>
                  </div>
                </div>
              `;
            });
            html += `</div>`;
          }

          wrapper.innerHTML = html;
          resultEl.appendChild(wrapper);
        });
      } catch (err) {
        console.error(err);
        statusEl.textContent = "選品に失敗しました：" + err;
        resultEl.innerHTML = "<div class='text-[11px] text-red-400'>サーバーエラーが発生しました。ログを確認してください。</div>";
      }
    });

    // STEP1 → STEP2/3 連携
    window.useForProfitMobile = function (catIndex, itemIndex) {
      const cat = window.lastAutoSelectResultsMobile[catIndex];
      if (!cat) return;
      const item = (cat.items || [])[itemIndex];
      if (!item) return;

      document.getElementById("profitProductIdMobile").value =
        (cat.jp_category || "cat") + "_" + (item.id || ("i" + itemIndex));
      document.getElementById("profitTitleCnMobile").value = item.title_cn || "";
      document.getElementById("costCnyMobile").value = item.price_cny ?? "";

      showStep(2);
      window.scrollTo({ top: 0, behavior: "smooth" });
    };

    window.useForListingMobile = function (catIndex, itemIndex) {
      const cat = window.lastAutoSelectResultsMobile[catIndex];
      if (!cat) return;
      const item = (cat.items || [])[itemIndex];
      if (!item) return;

      document.getElementById("listingTitleCnMobile").value = item.title_cn || "";
      document.getElementById("listingDescCnMobile").value = "";
      document.getElementById("listingKeywordsJpMobile").value =
        (cat.jp_category || "").replace("Amazon｜", "").replace(/[（）\(\)]/g, " ");

      showStep(3);
      window.scrollTo({ top: 0, behavior: "smooth" });
    };

    // ====== STEP2: 利益シミュレーション ======
    document.getElementById("profitFormMobile").addEventListener("submit", async (e) => {
      e.preventDefault();
      const resultEl = document.getElementById("profitResultMobile");
      resultEl.textContent = "計算中…";

      const fxRate = parseFloat(document.getElementById("fxRateMobile").value || "21");
      const feeRate = parseFloat(document.getElementById("feeRateMobile").value || "0.15");
      const productId = document.getElementById("profitProductIdMobile").value || "p1";
      const titleCn = document.getElementById("profitTitleCnMobile").value || "";
      const costCny = parseFloat(document.getElementById("costCnyMobile").value || "0");
      const shippingCny = parseFloat(document.getElementById("shippingCnyMobile").value || "0");
      const otherFeeJpy = parseFloat(document.getElementById("otherFeeJpyMobile").value || "0");
      const sellPriceJpy = parseFloat(document.getElementById("sellPriceJpyMobile").value || "0");

      const payload = {
        fx_rate: fxRate,
        rakuten_fee_rate: feeRate,
        items: [
          {
            product_id: productId,
            title_cn: titleCn,
            cost_cny: costCny,
            shipping_cny: shippingCny,
            sell_price_jpy: sellPriceJpy,
            other_fee_jpy: otherFeeJpy
          }
        ]
      };

      try {
        const resp = await secureFetch("/rakuten_profit_simulate", {
          method: "POST",
          body: JSON.stringify(payload),
        });

        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        const item = (data.items || [])[0];
        if (!item) {
          resultEl.innerHTML = "<div class='text-[11px] text-red-400'>計算結果が空です。</div>";
          return;
        }

        resultEl.innerHTML = `
          <div class="rounded-2xl border border-slate-800 bg-slate-900 p-3 space-y-1">
            <div class="text-[10px] text-slate-400">商品ID：${item.product_id}</div>
            <div class="text-[11px]">${item.title_cn || ""}</div>
            <div class="text-[11px] text-slate-300 mt-1">
              総コスト：<span class="font-semibold">${item.cost_total_jpy}</span> 円
            </div>
            <div class="text-[11px] text-slate-300">
              楽天手数料（概算）：<span class="font-semibold">${item.rakuten_fee_jpy}</span> 円
            </div>
            <div class="text-[11px] text-slate-300">
              1件あたり粗利：<span class="font-semibold">${item.gross_profit_jpy}</span> 円
            </div>
            <div class="text-[11px] text-slate-300">
              利益率：<span class="font-semibold">${(item.margin * 100).toFixed(1)}%</span>
            </div>
            <div class="text-[11px] text-emerald-400 mt-1">${item.advice}</div>
          </div>
        `;
      } catch (err) {
        console.error(err);
        resultEl.innerHTML = "<div class='text-[11px] text-red-400'>利益シミュレーションに失敗しました：" + err + "</div>";
      }
    });

    // ====== STEP3: 文案生成 ======
    document.getElementById("listingFormMobile").addEventListener("submit", async (e) => {
      e.preventDefault();
      const resultEl = document.getElementById("listingResultMobile");
      resultEl.textContent = "生成中…";

      const titleCn = document.getElementById("listingTitleCnMobile").value || "";
      const descCn = document.getElementById("listingDescCnMobile").value || "";
      const kwRaw = document.getElementById("listingKeywordsJpMobile").value || "";
      const tone = document.getElementById("listingToneMobile").value || "シンプル";

      const keywordsJp = kwRaw
        .split(",")
        .map((s) => s.trim())
        .filter((s) => s.length > 0);

      const payload = {
        title_cn: titleCn,
        desc_cn: descCn,
        keywords_jp: keywordsJp,
        shop_tone: tone
      };

      try {
        const resp = await secureFetch("/rakuten_listing_copy", {
          method: "POST",
          body: JSON.stringify(payload),
        });

        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();

        if (data.raw_text) {
          resultEl.innerHTML = `
            <div class="rounded-2xl border border-slate-800 bg-slate-900 p-3">
              <div class="text-[11px] text-red-400 mb-1">JSON 解析に失敗したため、生テキストを表示します。</div>
              <pre class="whitespace-pre-wrap text-[11px]">${data.raw_text}</pre>
            </div>
          `;
          return;
        }

        resultEl.innerHTML = `
          <div class="rounded-2xl border border-slate-800 bg-slate-900 p-3 space-y-2">
            <div>
              <div class="text-[11px] font-medium text-slate-300 mb-1">楽天用タイトル</div>
              <div class="text-[11px]">${data.title_jp || ""}</div>
            </div>
            <div>
              <div class="text-[11px] font-medium text-slate-300 mb-1">箇条書き（売りポイント）</div>
              <ul class="list-disc list-inside text-[11px] space-y-0.5">
                ${(data.bullets_jp || [])
                  .map((b) => `<li>${b}</li>`)
                  .join("")}
              </ul>
            </div>
            <div>
              <div class="text-[11px] font-medium text-slate-300 mb-1">商品説明文</div>
              <div class="text-[11px] whitespace-pre-wrap">${data.description_jp || ""}</div>
            </div>
            <div>
              <div class="text-[11px] font-medium text-slate-300 mb-1">検索キーワード候補</div>
              <div class="text-[11px] text-slate-300">
                ${(data.search_keywords_jp || []).join(" / ")}
              </div>
            </div>
          </div>
        `;
      } catch (err) {
        console.error(err);
        resultEl.innerHTML = "<div class='text-[11px] text-red-400'>文案生成に失敗しました：" + err + "</div>";
      }
    });

    // ====== 1688 URL インポート（モバイル用） ======
    let lastParsed1688ItemMobile = null;

    const aliUrlFormMobile = document.getElementById("aliUrlFormMobile");
    if (aliUrlFormMobile) {
      aliUrlFormMobile.addEventListener("submit", async (e) => {
        e.preventDefault();
        const urlInput = document.getElementById("aliUrlInputMobile");
        const url = (urlInput.value || "").trim();
        const resultEl = document.getElementById("aliUrlResultMobile");

        if (!url) {
          resultEl.textContent = "1688 の商品URLを入力してください。";
          resultEl.className = "text-xs text-red-400";
          return;
        }

        resultEl.textContent = "解析中...";
        resultEl.className = "text-xs text-slate-400";

        try {
          const resp = await secureFetch("/ali1688/parse_url", {
            method: "POST",
            body: JSON.stringify({ url }),
          });

          if (!resp.ok) {
            const errJson = await resp.json().catch(() => null);
            const msg = errJson?.detail || ("HTTP " + resp.status);
            throw new Error(msg);
          }

          const data = await resp.json();
          lastParsed1688ItemMobile = data;

          resultEl.innerHTML = `
            <div class="border border-emerald-500/40 rounded-lg p-2 space-y-1">
              <div class="font-semibold text-xs text-slate-50 mb-1">解析結果</div>
              <div class="text-xs"><span class="font-medium">タイトル（CN）：</span>${data.title_cn || "(取得できませんでした)"}</div>
              <div class="text-xs"><span class="font-medium">価格（CNY）：</span>${data.price_cny ?? "(不明)"}</div>
              <div class="flex gap-2 mt-1">
                <button type="button"
                  class="flex-1 py-1 rounded bg-emerald-500 text-[11px] font-semibold text-slate-950"
                  onclick="applyParsed1688ToProfitMobile()">
                  利益試算に反映
                </button>
                <button type="button"
                  class="flex-1 py-1 rounded bg-indigo-500 text-[11px] font-semibold text-slate-50"
                  onclick="applyParsed1688ToListingMobile()">
                  文案に反映
                </button>
              </div>
            </div>
          `;
        } catch (err) {
          console.error(err);
          resultEl.textContent = "解析に失敗しました：" + err;
          resultEl.className = "text-xs text-red-400";
        }
      });
    }

    window.applyParsed1688ToProfitMobile = function () {
      if (!lastParsed1688ItemMobile) return;
      const it = lastParsed1688ItemMobile;
      const titleInput = document.getElementById("profitTitleCnMobile");
      const costInput = document.getElementById("costCnyMobile");

      if (titleInput && it.title_cn) {
        titleInput.value = it.title_cn;
      }
      if (costInput && typeof it.price_cny === "number") {
        costInput.value = it.price_cny;
      }
    };

    window.applyParsed1688ToListingMobile = function () {
      if (!lastParsed1688ItemMobile) return;
      const it = lastParsed1688ItemMobile;
      const titleInput = document.getElementById("listingTitleCnMobile");
      if (titleInput && it.title_cn) {
        titleInput.value = it.title_cn;
      }
    };

    // 初期表示
    showStep(1);
   
    // ===== 初回アクセス時にパスワード確認（モバイル用） =====
document.addEventListener("DOMContentLoaded", () => {
  // 起動後すぐにトークン確認（未登録ならプロンプト表示）
  ensureToken().catch((err) => {
    console.warn("初回トークン確認エラー:", err);
    // ユーザーがキャンセルした場合などは、そのまま放置して、
    // 実際にボタン押下時にもう一度聞かれる。
  });
});


  </script>
</body>
</html>
